<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | Calendar of Events</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Franklin:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'pathway-navy': '#002E5D',
                        'pathway-blue': '#0062B8',
                        'pathway-light': '#E6F0FA',
                        'pathway-sky': '#B3D4FC',
                        'pathway-gold': '#FFB81C',
                        'pathway-white': '#FFFFFF',
                        'pathway-gray': '#63666A',
                        'pathway-dark': '#1A1A2E',
                    },
                    fontFamily: {
                        'sans': ['Libre Franklin', 'sans-serif'],
                    },
                },
            },
        }
    </script>
</head>
<body class="font-sans bg-pathway-light min-h-screen text-pathway-dark">
    <!-- Header Banner -->
    <header class="bg-pathway-navy text-white shadow-lg">
        <div class="max-w-6xl mx-auto px-6 py-5">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-pathway-navy" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11zM9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm-8 4H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z"/>
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold tracking-tight">Calendar of Events</h1>
                            <p class="text-pathway-sky text-sm">Admin Dashboard</p>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <a href="/" class="flex items-center gap-2 text-pathway-sky hover:text-white transition-colors text-sm">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                        View Calendar
                    </a>
                    <span class="bg-pathway-gold text-pathway-navy text-xs font-semibold px-3 py-1 rounded-full">Admin</span>
                    <a href="/logout" class="flex items-center gap-2 text-pathway-sky hover:text-white transition-colors text-sm">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
                        Logout
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-6 py-8">
        <!-- Stats Overview -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="bg-white rounded-xl p-5 shadow-sm border-l-4 border-pathway-navy">
                <p class="text-sm text-pathway-gray mb-1">Total Events</p>
                <p class="text-2xl font-bold text-pathway-navy" id="total-count">0</p>
            </div>
            <div class="bg-white rounded-xl p-5 shadow-sm border-l-4 border-pathway-blue">
                <p class="text-sm text-pathway-gray mb-1">Upcoming Events</p>
                <p class="text-2xl font-bold text-pathway-blue" id="upcoming-count">0</p>
            </div>
            <div class="bg-white rounded-xl p-5 shadow-sm border-l-4 border-pathway-gold">
                <p class="text-sm text-pathway-gray mb-1">Total Images</p>
                <p class="text-2xl font-bold text-pathway-gold" id="images-count">0</p>
            </div>
        </div>

        <!-- Create New Event Form -->
        <div class="bg-white rounded-xl p-6 shadow-sm mb-8">
            <h2 class="text-lg font-bold text-pathway-navy mb-4 flex items-center gap-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                Create New Event
            </h2>
            <form id="event-form" class="space-y-4" enctype="multipart/form-data">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-pathway-gray mb-1">Event Title</label>
                        <input type="text" id="title" name="title" required
                            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-pathway-blue focus:border-transparent"
                            placeholder="Enter event title">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-pathway-gray mb-1">Date</label>
                            <input type="date" id="event_date" name="event_date" required
                                class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-pathway-blue focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-pathway-gray mb-1">Time</label>
                            <input type="text" id="event_time" name="event_time"
                                class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-pathway-blue focus:border-transparent"
                                placeholder="e.g., 2:00 PM">
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-pathway-gray mb-1">Location</label>
                        <input type="text" id="location" name="location"
                            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-pathway-blue focus:border-transparent"
                            placeholder="Enter event location">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-pathway-gray mb-1">Category</label>
                        <select id="category" name="category"
                            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-pathway-blue focus:border-transparent">
                            <option value="general">General</option>
                            <option value="academic">Academic</option>
                            <option value="social">Social</option>
                            <option value="spiritual">Spiritual</option>
                            <option value="career">Career</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-pathway-gray mb-1">Description</label>
                    <textarea id="description" name="description" rows="3" required
                        class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-pathway-blue focus:border-transparent resize-none"
                        placeholder="Enter event description"></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-pathway-gray mb-1">Organizer's Name</label>
                        <input type="text" id="author" name="author" required
                            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-pathway-blue focus:border-transparent"
                            placeholder="Enter organizer name">
                    </div>
                </div>
                <!-- Image Upload -->
                <div>
                    <label class="block text-sm font-medium text-pathway-gray mb-1">Event Images</label>
                    <div class="border-2 border-dashed border-gray-200 rounded-lg p-6 text-center hover:border-pathway-blue transition-colors" id="drop-zone">
                        <input type="file" id="images" name="images" multiple accept="image/*" class="hidden">
                        <svg class="w-10 h-10 mx-auto text-pathway-gray mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <p class="text-pathway-gray mb-1">Drag and drop images here, or <button type="button" onclick="document.getElementById('images').click()" class="text-pathway-blue hover:underline">browse</button></p>
                        <p class="text-xs text-pathway-gray">PNG, JPG, GIF up to 16MB each</p>
                    </div>
                    <div id="image-preview" class="flex flex-wrap gap-2 mt-3"></div>
                </div>
                <div class="flex justify-end">
                    <button type="submit"
                        class="bg-pathway-navy text-white px-6 py-2 rounded-lg font-medium hover:bg-pathway-blue transition-colors flex items-center gap-2">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                        Create Event
                    </button>
                </div>
            </form>
        </div>

        <!-- Events List -->
        <div class="bg-white rounded-xl p-6 shadow-sm">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-bold text-pathway-navy flex items-center gap-2">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/></svg>
                    All Events
                </h2>
                <div class="flex gap-2 flex-wrap">
                    <button onclick="filterEvents('all')" class="filter-btn active px-3 py-1 text-sm rounded-lg bg-pathway-navy text-white" data-filter="all">All</button>
                    <button onclick="filterEvents('academic')" class="filter-btn px-3 py-1 text-sm rounded-lg bg-gray-100 text-pathway-gray hover:bg-pathway-light" data-filter="academic">Academic</button>
                    <button onclick="filterEvents('social')" class="filter-btn px-3 py-1 text-sm rounded-lg bg-gray-100 text-pathway-gray hover:bg-pathway-light" data-filter="social">Social</button>
                    <button onclick="filterEvents('spiritual')" class="filter-btn px-3 py-1 text-sm rounded-lg bg-gray-100 text-pathway-gray hover:bg-pathway-light" data-filter="spiritual">Spiritual</button>
                    <button onclick="filterEvents('career')" class="filter-btn px-3 py-1 text-sm rounded-lg bg-gray-100 text-pathway-gray hover:bg-pathway-light" data-filter="career">Career</button>
                </div>
            </div>
            <div id="events-list" class="space-y-4">
                <p class="text-center text-pathway-gray py-8">Loading events...</p>
            </div>
        </div>
    </main>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-xl">
            <h3 class="text-lg font-bold text-pathway-navy mb-2">Delete Event</h3>
            <p class="text-pathway-gray mb-4">Are you sure you want to delete this event? All associated images will also be deleted. This action cannot be undone.</p>
            <div class="flex justify-end gap-3">
                <button onclick="closeDeleteModal()" class="px-4 py-2 rounded-lg border border-gray-200 text-pathway-gray hover:bg-gray-50">Cancel</button>
                <button onclick="confirmDelete()" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="mt-12 border-t border-pathway-sky/30 bg-white">
        <div class="max-w-6xl mx-auto px-6 py-6">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4 text-sm text-pathway-gray">
                <p>¬© 2026 BYU-Pathway Worldwide. All rights reserved.</p>
                <div class="flex items-center gap-6">
                    <a href="#" class="hover:text-pathway-navy transition-colors">Privacy Policy</a>
                    <a href="#" class="hover:text-pathway-navy transition-colors">Terms of Use</a>
                    <a href="#" class="hover:text-pathway-navy transition-colors">Contact</a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        const API_URL = '/api';
        let currentFilter = 'all';
        let deleteEventId = null;
        let selectedFiles = [];

        // Load events on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadEvents();
            loadStats();
            setupImageUpload();
        });

        function setupImageUpload() {
            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('images');
            const preview = document.getElementById('image-preview');

            // Drag and drop handlers
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('border-pathway-blue', 'bg-pathway-light');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('border-pathway-blue', 'bg-pathway-light');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-pathway-blue', 'bg-pathway-light');
                handleFiles(e.dataTransfer.files);
            });

            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }

        function handleFiles(files) {
            const preview = document.getElementById('image-preview');
            
            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    selectedFiles.push(file);
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const div = document.createElement('div');
                        div.className = 'relative group';
                        div.innerHTML = `
                            <img src="${e.target.result}" class="w-20 h-20 object-cover rounded-lg">
                            <button type="button" onclick="removePreviewImage(this, ${selectedFiles.length - 1})" 
                                class="absolute -top-2 -right-2 w-5 h-5 bg-red-500 text-white rounded-full text-xs flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">√ó</button>
                        `;
                        preview.appendChild(div);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function removePreviewImage(btn, index) {
            selectedFiles.splice(index, 1);
            btn.parentElement.remove();
        }

        // Form submission
        document.getElementById('event-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            
            // Remove the file input's files and add our selectedFiles
            formData.delete('images');
            selectedFiles.forEach(file => {
                formData.append('images', file);
            });
            
            try {
                const response = await fetch(`${API_URL}/events`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    e.target.reset();
                    selectedFiles = [];
                    document.getElementById('image-preview').innerHTML = '';
                    loadEvents();
                    loadStats();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Failed to create event');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to connect to server');
            }
        });

        async function loadStats() {
            try {
                const response = await fetch(`${API_URL}/events/stats`);
                const stats = await response.json();
                document.getElementById('total-count').textContent = stats.total;
                document.getElementById('upcoming-count').textContent = stats.upcoming;
                document.getElementById('images-count').textContent = stats.total_images;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadEvents() {
            try {
                const response = await fetch(`${API_URL}/events`);
                const events = await response.json();
                renderEvents(events);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('events-list').innerHTML = 
                    '<p class="text-center text-pathway-gray py-8">Failed to load events. Make sure the server is running.</p>';
            }
        }

        function renderEvents(events) {
            const filtered = currentFilter === 'all' 
                ? events 
                : events.filter(e => e.category === currentFilter);
            
            if (filtered.length === 0) {
                document.getElementById('events-list').innerHTML = 
                    '<p class="text-center text-pathway-gray py-8">No events found.</p>';
                return;
            }
            
            const html = filtered.map(event => `
                <div class="border border-gray-100 rounded-lg p-4 hover:bg-pathway-light/50 transition-colors">
                    <div class="flex items-start gap-4">
                        ${event.images && event.images.length > 0 ? `
                            <div class="flex-shrink-0 flex gap-1">
                                ${event.images.slice(0, 3).map(img => `
                                    <img src="/uploads/${img.filename}" class="w-16 h-16 object-cover rounded-lg">
                                `).join('')}
                                ${event.images.length > 3 ? `<span class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center text-sm text-pathway-gray">+${event.images.length - 3}</span>` : ''}
                            </div>
                        ` : ''}
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1 flex-wrap">
                                <span class="text-xs font-semibold uppercase px-2 py-0.5 rounded ${getCategoryClass(event.category)}">${event.category}</span>
                                <span class="text-xs text-pathway-gray">${formatDate(event.event_date)}</span>
                                ${event.event_time ? `<span class="text-xs text-pathway-gray">‚Ä¢ ${escapeHtml(event.event_time)}</span>` : ''}
                            </div>
                            <h3 class="font-semibold text-pathway-navy">${escapeHtml(event.title)}</h3>
                            <p class="text-sm text-pathway-gray mt-1 line-clamp-2">${escapeHtml(event.description)}</p>
                            ${event.location ? `<p class="text-xs text-pathway-gray mt-1">üìç ${escapeHtml(event.location)}</p>` : ''}
                            <p class="text-xs text-pathway-gray mt-1">By: ${escapeHtml(event.author)}</p>
                        </div>
                        <div class="flex-shrink-0">
                            <button onclick="deleteEvent(${event.id})" class="w-8 h-8 rounded-lg flex items-center justify-center text-pathway-gray hover:bg-red-50 hover:text-red-600 transition-colors" title="Delete">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('events-list').innerHTML = html;
        }

        function getCategoryClass(category) {
            const classes = {
                'general': 'bg-gray-100 text-pathway-gray',
                'academic': 'bg-blue-100 text-blue-700',
                'social': 'bg-pink-100 text-pink-700',
                'spiritual': 'bg-purple-100 text-purple-700',
                'career': 'bg-green-100 text-green-700'
            };
            return classes[category] || classes['general'];
        }

        function filterEvents(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.dataset.filter === filter) {
                    btn.classList.remove('bg-gray-100', 'text-pathway-gray');
                    btn.classList.add('bg-pathway-navy', 'text-white');
                } else {
                    btn.classList.remove('bg-pathway-navy', 'text-white');
                    btn.classList.add('bg-gray-100', 'text-pathway-gray');
                }
            });
            loadEvents();
        }

        function deleteEvent(id) {
            deleteEventId = id;
            document.getElementById('delete-modal').classList.remove('hidden');
        }

        function closeDeleteModal() {
            deleteEventId = null;
            document.getElementById('delete-modal').classList.add('hidden');
        }

        async function confirmDelete() {
            if (!deleteEventId) return;
            
            try {
                const response = await fetch(`${API_URL}/events/${deleteEventId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    closeDeleteModal();
                    loadEvents();
                    loadStats();
                } else {
                    alert('Failed to delete event');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to connect to server');
            }
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
